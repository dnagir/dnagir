
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Testing Rails across time zones - Art Of Programming</title>
  <meta name="author" content="Dmytrii Nagirniak">

  
  <meta name="description" content="Why? Because it is easy to get the dates/times wrong without even realising it.
Even if you don&rsquo;t need to support multiple time zones, you can &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ApproachE.com/blog/testing-rails-across-time-zones">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/DmitriyNagirnyak" rel="alternate" title="Art Of Programming" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-17928352-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Art Of Programming</a></h1>
  
    <h2>musings by Dmytrii Nagirniak</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="http://feeds.feedburner.com/DmitriyNagirnyak" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="http://feedburner.google.com/fb/a/mailverify?uri=DmitriyNagirnyak" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ApproachE.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="/blog/archives/">Blog</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Testing Rails Across Time Zones</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-10T11:14:00+10:00" pubdate data-updated="true">Jul 10<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>Why?</h2>

<p>Because it is easy to get the dates/times wrong without even realising it.
Even if you don&rsquo;t need to support multiple time zones, you can catch a lot of
the edge cases.</p>

<h2>How?</h2>

<ol>
<li>Randomise time zone when running specs</li>
<li>Run the specific specs across the different time zones</li>
</ol>


<!-- more -->


<h2>Usage: Randomise time zone when running specs</h2>

<p>The RSpec support file (see below) will set the Rails&#8217; <code>Time.zone</code> to a random time zone.
So if something is wrong then your CI should eventually fail.</p>

<p>When it will, you should look for the message at the very beginning:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Current rand time zone: (GMT+06:30) Rangoon. Repro: Time.zone = ActiveSupport::TimeZone["Rangoon"]</span></code></pre></td></tr></table></div></figure>


<p>Then go to your failing spec and in the context of it add the following
(assuming you copy pasted the &ldquo;Repro&rdquo; part from the message):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">before</span> <span class="p">{</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span> <span class="o">=</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:TimeZone</span><span class="o">[</span><span class="s2">&quot;Rangoon&quot;</span><span class="o">]</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you can re-run the spec and it should repeatably and predictably fail (much like RSpec&rsquo;s random order with a given seed).</p>

<p>This works without changing any of the existing specs and relies on
the fact that your CI is running specs often enough.</p>

<h2>Usage: Run the specific specs across the different time zones</h2>

<p>You may have some specs that you want to specifically test across all the time zones.
That doesn&rsquo;t mean you want to support all time zone, it just means that the transitions
between the dates are very important.
Getting it run for all timezones will give good confidence about the correctness of the functionality, even for one time zone.</p>

<p>This can be used, for example, with tests on reports that are quite sensitive
(all financial/sales reports probably).</p>

<p>So how do you do it?</p>

<p>Just write the normal specs without thinking about the time zone.
Let&rsquo;s take this as an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">SalesReport</span>
</span><span class='line'>  <span class="n">describe</span> <span class="no">SalesChart</span>  <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;should return chart with data for a week as daily summary&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">create_three_reservations_per_day</span> <span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">1</span>
</span><span class='line'>      <span class="n">chart</span> <span class="o">=</span> <span class="no">SalesChart</span><span class="o">.</span><span class="n">for_company</span><span class="p">(</span><span class="n">reservations</span><span class="p">,</span> <span class="n">company</span><span class="p">)</span>
</span><span class='line'>      <span class="n">chart</span><span class="o">.</span><span class="n">data_table</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">4</span>
</span><span class='line'>      <span class="n">rows_from</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span>
</span><span class='line'>        <span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="o">.</span><span class="n">to_date</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="o">[</span><span class="no">Date</span><span class="o">.</span><span class="n">current</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span>
</span><span class='line'>      <span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># helpers ommited...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure it passes in your timezone.</p>

<p>Then just wrap your spec in <code>across_time_zones</code>, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">SalesReport</span>
</span><span class='line'>  <span class="n">describe</span> <span class="no">SalesChart</span>  <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">across_time_zones</span> <span class="ss">step</span><span class="p">:</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should return chart with data for a week as daily summary&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">create_three_reservations_per_day</span> <span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">1</span>
</span><span class='line'>        <span class="n">chart</span> <span class="o">=</span> <span class="no">SalesChart</span><span class="o">.</span><span class="n">for_company</span><span class="p">(</span><span class="n">reservations</span><span class="p">,</span> <span class="n">company</span><span class="p">)</span>
</span><span class='line'>        <span class="n">chart</span><span class="o">.</span><span class="n">data_table</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">4</span>
</span><span class='line'>        <span class="n">rows_from</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span>
</span><span class='line'>          <span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="o">.</span><span class="n">to_date</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="o">[</span><span class="no">Date</span><span class="o">.</span><span class="n">current</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span>
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># helpers ommited...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll be surprised how many things can go wrong. Especially if you have some more advanced DB queries
that use (in PostgreSQL terms) dates, times and times with time zone, maybe <code>DATE_TRUNC</code> etc.</p>

<p>Now that spec will be created for each time zone with the given step.</p>

<h2>Tips/Gotchas</h2>

<ul>
<li>The default <code>step</code> here is set to 8 hours (it is optional), meaning that only 3 time zones will be tested. It may be sufficient or may not. So prefer to provide it expclicitly.</li>
<li>The smaller the <code>step</code> is, the more specs will be created and the slower the example will become. So choose the number wisely (less than 2 hours is <em>usually</em> not necessary).</li>
<li>Always, always use <code>Time.zone.now</code> (or <code>Time.current</code>) instead of <code>Time.now</code>.</li>
<li>Always, always use <code>Date.current</code> instead of <code>Date.today</code>.</li>
<li>Move any <code>let!</code> (with bang) and <code>before</code> blocks under the <code>across_time_zones</code> to ensure the correct time zone is used at all times.</li>
</ul>


<p>You can grab the RSpec <a href="https://gist.github.com/dnagir/5962765">support file</a> to leaverage it.
Feedback on this is welcome.</p>

<div><script src='https://gist.github.com/5962765.js'></script>
<noscript><pre><code></code></pre></noscript></div>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Dmytrii Nagirniak</span></span>

      








  


<time datetime="2013-07-10T11:14:00+10:00" pubdate data-updated="true">Jul 10<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/development/'>development</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://ApproachE.com/blog/testing-rails-across-time-zones/" data-via="dnagir" data-counturl="http://ApproachE.com/blog/testing-rails-across-time-zones/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/increase-your-productivity-with-vim-and-terminal/" title="Previous Post: Increase your productivity in Vim and Terminal">&laquo; Increase your productivity in Vim and Terminal</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Dmytrii Nagirniak</h1>
  <img src="/about/me.jpg" title="Dmytrii Nagirniak photo" >
  <ul>
    <li>
      <a href="http://twitter.com/dnagir">Twitter</a>
    </li>
    <li>
      <a href="http://github.com/dnagir">Github</a>
    </li>
    <li>
      <a href="http://au.linkedin.com/in/dmitriynagirnyak">LinkedIn</a>
    </li>
    <li>
      <a href="mailto:d@ApproachE.com?subject=Just saying hi">d@ApproachE.com</a>
    </li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/testing-rails-across-time-zones/">Testing Rails across time zones</a>
      </li>
    
      <li class="post">
        <a href="/blog/increase-your-productivity-with-vim-and-terminal/">Increase your productivity in Vim and Terminal</a>
      </li>
    
      <li class="post">
        <a href="/blog/how-to-care-for-introverts/">How to care for Introverts</a>
      </li>
    
      <li class="post">
        <a href="/blog/migrating-from-blogger-to-octopress/">Migrating from Blogger to Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/knockoutjs-validations-video/">KnockoutJS Validations Screencast</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("dnagir", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/dnagir" class="twitter-follow-button" data-show-count="false">Follow @dnagir</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Dmytrii Nagirniak -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'approache';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ApproachE.com/blog/testing-rails-across-time-zones/';
        var disqus_url = 'http://ApproachE.com/blog/testing-rails-across-time-zones/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
