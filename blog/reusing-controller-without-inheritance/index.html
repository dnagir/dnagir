
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Reusing Controller without inheritance - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="I created couple of controllers that provide some predefined functionality. All I needed is just to inherit from them. Then I decided to move them &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://w.ApproachE.com/blog/reusing-controller-without-inheritance">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:w.ApproachE.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="/blog">Blog</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Reusing Controller Without Inheritance</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-08T12:41:00+11:00" pubdate data-updated="true">Jan 8<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><div class='post'>
I created couple of controllers that provide some predefined functionality. All I needed is just to inherit from them. Then I decided to move them in a separate library so I would be able to reuse it in other projects. But then I faced a problem. Controllers of my project are forced to be inherited from those ones.<br />
Thou I don&#8217;t have a problem with it, I additionally want every controller to have more functionality in it. You know, we always want to have something common in all our controllers.<br />
If .NET would support <a href="http://en.wikipedia.org/wiki/Multiple_inheritance" target="_blank">multiple inheritance</a> it would not be a problem at all.<br />
So what I really need in my project is:<br />
<ol>
<li>Be able to inherit from any controller in.</li>
<li>Have additional functionality in any controller.</li>
<li>Have NO code duplicates.</li>
</ol>
<br />
Again. If we inherit - we cannot have common ADDITIONAL functionality (except the inherited one) and we&#8217;ll have to duplicate all the code needed in each controller (it seems so at first glance).<br />
But it is not the case if the base controller supports extensibility. I remembered about <a href="http://www.castleproject.org/MonoRail/documentation/trunk/advanced/dynactions.html" target="_blank">IDynamicActions</a> but it&#8217;s not fully what I need. I just need to add common functionality to all controllers without inheritance. DynamicActions reuse actions (which I might need soon but not for now).<br />
Then I remembered <a href="http://ayende.com/Blog/archive/2008/06/04/Review-Umbrella-project.aspx" target="_blank">Umbrella Project Review</a> and it&#8217;s extension points. The idea was good enough for me and I decided to go with it, but in a simplified way.<br />
No more words. The end result is below (sample controllers):<br />
<div>
<pre style="background-color: #f4f4f4; border-style: none; color: black; font-family: consolas,'Courier New',courier,monospace; font-size: 8pt; line-height: 12pt; margin: 0em; overflow: visible; padding: 0px; width: 100%;"><span style="color: green;">// Notice CommonControllerExtension and this.Extension</span>
<span style="color: blue;">public</span> <span style="color: blue;">class</span> HomeController : AbstractBaseController&lt;CommonControllerExtension&gt; {
    <span style="color: blue;">public</span> ActionResult Index() {
        ViewData[<span style="color: #006080;">"Username"</span>] = Extension.User.Username;
        <span style="color: blue;">return</span> View();
    }
}</pre>
</div>
and other controller<br />
<div>
<pre style="background-color: #f4f4f4; border-style: none; color: black; font-family: consolas,'Courier New',courier,monospace; font-size: 8pt; line-height: 12pt; margin: 0em; overflow: visible; padding: 0px; width: 100%;"><span style="color: blue;">public</span> <span style="color: blue;">class</span> TopicController : CrudController&lt;Topic, CommonControllerExtension&gt; {
    <span style="color: blue;">protected</span> <span style="color: blue;">override</span> <span style="color: blue;">void</span> PrepareUpdateInfo(UpdateModelInfo updateInfo) {
        updateInfo.Include(<span style="color: #006080;">"Name"</span>, <span style="color: #006080;">"Content"</span>);
    }

    <span style="color: blue;">protected</span> <span style="color: blue;">override</span> IEnumerable&lt;Topic&gt; GetObjectsToList() {
        <span style="color: green;">// Note Extension.WorkSpace!</span>
        <span style="color: blue;">return</span> Extension.WorkSpace.Query().Ocl&lt;Topic&gt;(<span style="color: #006080;">"Topic.allInstances-&gt;orderBy(CreatedDate)"</span>);
    }
}</pre>
</div>
<br />
The point is that we have two completely different controllers: HomeController is inherited from the abstract one; the TopicController is inherited from the CrudController (which is in turn inherited from abstract one). What they have in common is:<br />
<ol>
<li>They explicitly or implicitly inherit from <span style="font-family: Courier New;">AbstractBaseController</span>.</li>
<li>They have the same generic parameter: <span style="font-family: Courier New;">CommonControllerExtension</span>.</li>
</ol>
The second point enables the controller to share common functionality via extension class. It can be single in the whole project or couple of them - your choice.<br />
Here the main thing <span style="font-family: Courier New;">AbstractBaseController</span><br />
<div>
<pre style="background-color: #f4f4f4; border-style: none; color: black; font-family: consolas,'Courier New',courier,monospace; font-size: 8pt; line-height: 12pt; margin: 0em; overflow: visible; padding: 0px; width: 100%;"><span style="color: blue;">public</span> <span style="color: blue;">abstract</span> <span style="color: blue;">class</span> AbstractBaseController&lt;TExtendPoint&gt; : Controller <span style="color: blue;">where</span> TExtendPoint : <span style="color: blue;">class</span>, IControllerExtensionPoint&lt;Controller&gt;, <span style="color: blue;">new</span>() {
    
    <span style="color: blue;">private</span> TExtendPoint extension;


    <span style="color: #cc6633;">#region</span> Overriden

    <span style="color: blue;">protected</span> <span style="color: blue;">override</span> <span style="color: blue;">void</span> OnActionExecuting(ActionExecutingContext filterContext) {
        <span style="color: blue;">base</span>.OnActionExecuting(filterContext);
        Extension.OnInit(filterContext);
        OnInit(filterContext);
    }
    <span style="color: blue;">protected</span> <span style="color: blue;">override</span> <span style="color: blue;">void</span> OnActionExecuted(ActionExecutedContext filterContext) {
        <span style="color: blue;">base</span>.OnActionExecuted(filterContext);
        Extension.OnBeforeRender(filterContext);
        OnBeforeRender(filterContext);
    }
    <span style="color: blue;">protected</span> <span style="color: blue;">override</span> <span style="color: blue;">void</span> OnResultExecuted(ResultExecutedContext filterContext) {
        OnEnd(filterContext);
        Extension.OnEnd(filterContext);
        <span style="color: blue;">base</span>.OnResultExecuted(filterContext);
    }

    <span style="color: #cc6633;">#endregion</span>


    
    <span style="color: blue;">public</span> TExtendPoint Extension {
        get {
            <span style="color: blue;">if</span> (extension != <span style="color: blue;">null</span>)
                <span style="color: blue;">return</span> extension;

            <span style="color: green;">// Create an instance with default constructor.</span>
            extension = <span style="color: blue;">new</span> TExtendPoint();
            extension.Controller = <span style="color: blue;">this</span>;
            <span style="color: blue;">return</span> extension;
        }
    }


    <span style="color: green;">/// &lt;summary&gt;</span>
    <span style="color: green;">/// Is called when controller is ready to be initialised with additional info.</span>
    <span style="color: green;">/// &lt;/summary&gt;</span>
    <span style="color: green;">/// &lt;param name="context"&gt;The context.&lt;/param&gt;</span>
    <span style="color: blue;">public</span> <span style="color: blue;">virtual</span> <span style="color: blue;">void</span> OnInit(ActionExecutingContext context) {
    }

    <span style="color: green;">/// &lt;summary&gt;</span>
    <span style="color: green;">/// Is called when controller done it's job and action has been executed, but before the view is rendered.</span>
    <span style="color: green;">/// &lt;/summary&gt;</span>
    <span style="color: green;">/// &lt;param name="context"&gt;The context.&lt;/param&gt;</span>
    <span style="color: blue;">public</span> <span style="color: blue;">virtual</span> <span style="color: blue;">void</span> OnBeforeRender(ActionExecutedContext context) {
    }

    <span style="color: green;">/// &lt;summary&gt;</span>
    <span style="color: green;">/// Is called when the request has been processed and the controller is ready to clean-up the resourse before it gets disposed.</span>
    <span style="color: green;">/// &lt;/summary&gt;</span>
    <span style="color: green;">/// &lt;param name="context"&gt;The context.&lt;/param&gt;</span>
    <span style="color: blue;">public</span> <span style="color: blue;">virtual</span> <span style="color: blue;">void</span> OnEnd(ResultExecutedContext context) {
    }


    <span style="color: green;">/// &lt;summary&gt;</span>
    <span style="color: green;">/// Gets or sets the head title which is ViewData["HeadTitle"]</span>
    <span style="color: green;">/// &lt;/summary&gt;</span>
    <span style="color: green;">/// &lt;value&gt;The head title.&lt;/value&gt;</span>
    <span style="color: blue;">public</span> <span style="color: blue;">string</span> HeadTitle {
        get {
            <span style="color: blue;">return</span> ViewData[<span style="color: #006080;">"HeadTitle"</span>].PropGet(o =&gt; o.ToString());
        }
        set {
            ViewData[<span style="color: #006080;">"HeadTitle"</span>] = <span style="color: blue;">value</span>;
        }
    }

}</pre>
</div>
<br />
And here is the IControllerExtensionPoint interface:<br />
<div>
<pre style="background-color: #f4f4f4; border-style: none; color: black; font-family: consolas,'Courier New',courier,monospace; font-size: 8pt; line-height: 12pt; margin: 0em; overflow: visible; padding: 0px; width: 100%;"><span style="color: green;">/// &lt;summary&gt;</span>
<span style="color: green;">/// The interface that allows to provide additional functionality to controller without inheritance.</span>
<span style="color: green;">/// The implementor must have the default constructor.</span>
<span style="color: green;">/// &lt;/summary&gt;</span>
<span style="color: green;">/// &lt;typeparam name="TController"&gt;The type of the controller.&lt;/typeparam&gt;</span>
<span style="color: blue;">public</span> <span style="color: blue;">interface</span> IControllerExtensionPoint&lt;TController&gt; <span style="color: blue;">where</span> TController: Controller {

    <span style="color: green;">/// &lt;summary&gt;</span>
    <span style="color: green;">/// Gets or sets the extending controller.</span>
    <span style="color: green;">/// The setter is automatically invoked just after the instance is created by the controller.</span>
    <span style="color: green;">/// &lt;/summary&gt;</span>
    <span style="color: green;">/// &lt;value&gt;The controller.&lt;/value&gt;</span>
    TController Controller { get; set; }


    <span style="color: green;">/// &lt;summary&gt;</span>
    <span style="color: green;">/// Is called when controller is ready to be initialised with additional info.</span>
    <span style="color: green;">/// &lt;/summary&gt;</span>
    <span style="color: green;">/// &lt;param name="context"&gt;The context.&lt;/param&gt;</span>
    <span style="color: blue;">void</span> OnInit(ActionExecutingContext context);

    <span style="color: green;">/// &lt;summary&gt;</span>
    <span style="color: green;">/// Is called when controller done it's job and action has been executed, but before the view is rendered.</span>
    <span style="color: green;">/// &lt;/summary&gt;</span>
    <span style="color: green;">/// &lt;param name="context"&gt;The context.&lt;/param&gt;</span>
    <span style="color: blue;">void</span> OnBeforeRender(ActionExecutedContext context);

    <span style="color: green;">/// &lt;summary&gt;</span>
    <span style="color: green;">/// Is called when the request has been processed and the controller is ready to clean-up the resourse before it gets disposed.</span>
    <span style="color: green;">/// &lt;/summary&gt;</span>
    <span style="color: green;">/// &lt;param name="context"&gt;The context.&lt;/param&gt;</span>
    <span style="color: blue;">void</span> OnEnd(ResultExecutedContext context);

}</pre>
</div>
Here&#8217;s the sample implementation sample:<br />
<div>
<pre style="background-color: #f4f4f4; border-style: none; color: black; font-family: consolas,'Courier New',courier,monospace; font-size: 8pt; line-height: 12pt; margin: 0em; overflow: visible; padding: 0px; width: 100%;"><span style="color: blue;">public</span> <span style="color: blue;">class</span> CommonControllerExtension : IControllerExtensionPoint&lt;Controller&gt;, IEcoServiceProvider {

    <span style="color: #cc6633;">#region</span> IControllerExtensionPoint&lt;Controller&gt; Members

    <span style="color: blue;">public</span> Controller Controller { get; set; }

    <span style="color: blue;">public</span> <span style="color: blue;">void</span> OnInit(ActionExecutingContext context) {
        User = GetTheUserFromSomewhere();
    }

    <span style="color: blue;">public</span> <span style="color: blue;">void</span> OnBeforeRender(ActionExecutedContext context) { 
    }

    <span style="color: blue;">public</span> <span style="color: blue;">void</span> OnEnd(ResultExecutedContext context) {
        <span style="color: blue;">if</span> (ProviderOfWorkSpace != <span style="color: blue;">null</span>)
            ProviderOfWorkSpace.ReleaseWorkSpace();
    }

    <span style="color: #cc6633;">#endregion</span>


    <span style="color: #cc6633;">#region</span> IEcoServiceProvider Members

    <span style="color: blue;">public</span> T GetEcoService&lt;T&gt;() <span style="color: blue;">where</span> T : <span style="color: blue;">class</span> {
        <span style="color: blue;">return</span> WorkSpace.GetEcoService&lt;T&gt;();
    }

    <span style="color: blue;">public</span> <span style="color: blue;">object</span> GetEcoService(Type serviceType) {
        <span style="color: blue;">return</span> WorkSpace.GetEcoService(serviceType);
    }

    <span style="color: #cc6633;">#endregion</span>



    <span style="color: blue;">public</span> IWorkSpaceProvider ProviderOfWorkSpace {
        get;
        set;
    }

    <span style="color: blue;">public</span> IWorkSpace WorkSpace {
        get {
            <span style="color: blue;">if</span> (ProviderOfWorkSpace == <span style="color: blue;">null</span>)
                ProviderOfWorkSpace = <span style="color: blue;">new</span> DefaultWebAppWorkSpaceProvider(() =&gt;
                    <span style="color: blue;">new</span> XmlWorkSpace());
            <span style="color: blue;">return</span> ProviderOfWorkSpace.GetWorkSpace();
        }
    }

    <span style="color: blue;">public</span> TObject GetObjectFromRequest&lt;TObject&gt;(<span style="color: blue;">string</span> name) <span style="color: blue;">where</span> TObject : <span style="color: blue;">class</span>, ILoopBack {
        var vpr = Controller.ValueProvider.GetValue(name);
        <span style="color: blue;">if</span> (vpr == <span style="color: blue;">null</span>)
            <span style="color: blue;">return</span> <span style="color: blue;">null</span>;
        <span style="color: blue;">return</span> WorkSpace.GetObject&lt;TObject&gt;(vpr.AttemptedValue);
    }

    <span style="color: blue;">public</span> User User { get; set; }
}</pre>
</div>
<br />
What we really have achieved here is reusing functionality with avoiding need of no multiple inheritance. It also supports notification via OnInit, OnBeforeRender and OnEnd methods.<br />
The drawback is that each controller must be inherited (implicitly or explicitly) from <span style="font-family: Courier New;">AbstractBaseController</span>. The price I&#8217;m ready to pay because of I inherit from Controller anyway.<br />
Enjoy!</div>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Your Name</span></span>

      








  


<time datetime="2009-01-08T12:41:00+11:00" pubdate data-updated="true">Jan 8<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/development/'>Development</a>, <a class='category' href='/blog/categories/asp-net-mvc/'>asp.net mvc</a>, <a class='category' href='/blog/categories/tricks/'>tricks</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://w.ApproachE.com/blog/reusing-controller-without-inheritance/" data-via="" data-counturl="http://w.ApproachE.com/blog/reusing-controller-without-inheritance/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/onactionexecuting-in-aspnet-mvc-unit/" title="Previous Post: OnActionExecuting in ASP.NET MVC unit tests">&laquo; OnActionExecuting in ASP.NET MVC unit tests</a>
      
      
        <a class="basic-alignment right" href="/blog/aspnet-masterpages-and-url-rebasing/" title="next Post: ASP.NET MasterPages and Url Rebasing">ASP.NET MasterPages and Url Rebasing &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Dmytrii Nagirniak</h1>
  <img src="/about/me.jpg" title="Dmytrii Nagirniak photo" >
  <ul>
    <li>
      <a href="http://twitter.com/dnagir">Twitter</a>
    </li>
    <li>
      <a href="http://github.com/dnagir">Github</a>
    </li>
    <li>
      <a href="http://au.linkedin.com/in/dmitriynagirnyak">LinkedIn</a>
    </li>
    <li>
      <a href="mailto:d@ApproachE.com?subject=Just saying hi">d@ApproachE.com</a>
    </li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/knockoutjs-validations-video/">KnockoutJS Validations Screencast</a>
      </li>
    
      <li class="post">
        <a href="/blog/issues-switching-to-jruby-from-mri-19/">Issues switching to JRuby from MRI 1.9</a>
      </li>
    
      <li class="post">
        <a href="/blog/rails-plugin-with-tested-assets/">Rails Plugin with Tested Assets Screencast</a>
      </li>
    
      <li class="post">
        <a href="/blog/tips-on-usingterminal-in-mac/">Use your Terminal like a Pro</a>
      </li>
    
      <li class="post">
        <a href="/blog/templating-done-easy-javascript-haml/">Templating done easy - JavaScript HAML with Rails</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
